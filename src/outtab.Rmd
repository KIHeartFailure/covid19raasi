```{r outaftercovidtab, cache=cacheon}

survmy <- function(time = "sos_outtime_death", event = "sos_death",
                   modname, data,
                   modvarsmy, weightsmy = c("weight_rasi", "weight_mra")) {
  tmpdata <- data

  out <- list(
    data.frame(matrix(NA, ncol = 5, nrow = 4, 1)),
    data.frame(matrix(NA, ncol = 5, nrow = 4, 1))
  )
  names(out) <- modvarsmy[1:2]

  for (i in 1:2) {
    out[[i]][1, 1] <- modname

    colnames(out[[i]]) <- c("Outcome/Subgroup", "Model", "No", "Yes", "p-value")

    ## incidence rate
    out[[i]][1, 2] <- "Incidence"

    tmpdata <- tmpdata %>%
      mutate(eventcount = if_else(!!sym(event) == "Yes", 1, 0))

    ev <- by(tmpdata$eventcount, tmpdata[, modvarsmy[i]], sum)
    s <- by(tmpdata[, time], tmpdata[, modvarsmy[i]], sum) / 365.25
    r <- pois.exact(x = ev, pt = s)

    out[[i]][1, 3:4] <- paste0(
      ev, ", ",
      dF(s, dig = 0), ", ",
      dF(r$rate, dig = 1), " (",
      dF(r$lower, dig = 1), "-",
      dF(r$upper, dig = 1), ")"
    )

    # cox regressions
    ## crude
    mod <- coxph(formula(paste0("Surv(", time, ",", event, "=='Yes') ~ ", modvarsmy[i])),
      data = tmpdata
    )
    smod <- summary(mod)
    out[[i]][2, 2] <- "Crude HR (95% CI)"
    out[[i]][2, 3:5] <- c(
      "ref", paste0(
        dF(smod$conf.int[1, 1], dig = 2),
        " (", dF(smod$conf.int[1, 3], dig = 2),
        "-", dF(smod$conf.int[1, 4], dig = 2), ")"
      ),
      dF(smod$coef[1, 5], dig = 3, p = TRUE)
    )

    ## adj ps ipw
    mod <- coxph(formula(paste0(
      "Surv(", time, ",", event, "=='Yes') ~ ",
      paste(modvarsmy, collapse = " + ")
    )),
    weights = tmpdata %>% pull(!!sym(weightsmy[i])),
    data = tmpdata
    )

    smod <- jtools::get_robust_se(mod, type = "HC0")

    out[[i]][4, 2] <- "Adj IPW HR (95% CI)"
    out[[i]][4, 3:5] <- c(
      "ref", paste0(
        dF(exp(smod$coefs[i, 1]), dig = 2),
        " (", dF(exp(smod$coefs[i, 1] - global_z05 * smod$coefs[i, 2]), dig = 2),
        "-", dF(exp(smod$coefs[i, 1] + global_z05 * smod$coefs[i, 2]), dig = 2), ")"
      ),
      dF(smod$coefs[i, 4], dig = 3, p = TRUE)
    )
  }

  ## adj
  mod <- coxph(formula(paste0(
    "Surv(", time, ",", event, "=='Yes') ~ ",
    paste(modvarsmy, collapse = " + ")
  )),
  data = tmpdata
  )
  smod <- summary(mod)
  out[[1]][3, 2] <- "Adj HR (95% CI)"
  out[[1]][3, 3:5] <- c(
    "ref", paste0(
      dF(smod$conf.int[1, 1], dig = 2),
      " (", dF(smod$conf.int[1, 3], dig = 2),
      "-", dF(smod$conf.int[1, 4], dig = 2), ")"
    ),
    dF(smod$coef[1, 5], dig = 3, p = TRUE)
  )
  out[[2]][3, 2] <- "Adj HR (95% CI)"
  out[[2]][3, 3:5] <- c(
    "ref", paste0(
      dF(smod$conf.int[2, 1], dig = 2),
      " (", dF(smod$conf.int[2, 3], dig = 2),
      "-", dF(smod$conf.int[2, 4], dig = 2), ")"
    ),
    dF(smod$coef[2, 5], dig = 3, p = TRUE)
  )

  return(out)
}


out11 <- survmy(
  modname = "All",
  data = pop %>% filter(sos_covidconfirmed == "Yes"),
  modvarsmy = c("sos_ddr_rasi", "sos_ddr_mra", modvarsns)
)
out12 <- survmy(
  modname = "HF",
  data = pop %>% filter(sos_covidconfirmed == "Yes" & sos_com_hf == "Yes"),
  modvarsmy = c("sos_ddr_rasi", "sos_ddr_mra", modvarsns[!modvarsns %in% "sos_com_hf"])
)
out13 <- survmy(
  modname = "Hypertension",
  data = pop %>% filter(sos_covidconfirmed == "Yes" & sos_com_hypertension == "Yes"),
  modvarsmy = c("sos_ddr_rasi", "sos_ddr_mra", modvarsns[!modvarsns %in% "sos_com_hypertension"])
)
out14 <- survmy(
  modname = "Kidney disease",
  data = pop %>% filter(sos_covidconfirmed == "Yes" & sos_com_renal == "Yes"),
  modvarsmy = c("sos_ddr_rasi", "sos_ddr_mra", modvarsns[!modvarsns %in% "sos_com_renal"])
)
out15 <- survmy(
  modname = "IHD",
  data = pop %>% filter(sos_covidconfirmed == "Yes" & sos_com_ihd == "Yes"),
  modvarsmy = c("sos_ddr_rasi", "sos_ddr_mra", modvarsns[!modvarsns %in% "sos_com_ihd"])
)
out16 <- survmy(
  modname = "Diabetes",
  data = pop %>% filter(sos_covidconfirmed == "Yes" & sos_com_diabetes == "Yes"),
  modvarsmy = c("sos_ddr_rasi", "sos_ddr_mra", modvarsns[!modvarsns %in% "sos_com_diabetes"])
)

out17 <- survmy(
  modname = "Stockholm",
  data = pop %>% filter(sos_covidconfirmed == "Yes" & scb_region_stockholm == "Yes"),
  modvarsmy = c("sos_ddr_rasi", "sos_ddr_mra", modvarsns[!modvarsns %in% "scb_region_stockholm"])
)


outcoxall <- cbind(
  rbind(
    out11[["sos_ddr_rasi"]], out12[["sos_ddr_rasi"]], out13[["sos_ddr_rasi"]],
    out14[["sos_ddr_rasi"]], out15[["sos_ddr_rasi"]], out16[["sos_ddr_rasi"]],
    out17[["sos_ddr_rasi"]]
  ),
  rbind(
    out11[["sos_ddr_mra"]], out12[["sos_ddr_mra"]], out13[["sos_ddr_mra"]],
    out14[["sos_ddr_mra"]], out15[["sos_ddr_mra"]], out16[["sos_ddr_mra"]],
    out17[["sos_ddr_mra"]]
  )[, 3:5]
)

write.xlsx(outcoxall, paste0("./output/tabs/deathaftercovid_", Sys.Date(), ".xlsx"), rowNames = FALSE)

myHeader <- c(" " = 1, " " = 1, "RASi" = 3, "MRA" = 3)
names(myHeader) <- c(" ", " ", "RASi", "MRA")


footnote(
  mykable(outcoxall,
    fontsize = 6,
    caption = "All-cause mortality after confirmed Covid-19"
  ) %>%
    landscape() %>%
    add_header_above(myHeader),
  general = c(
    "Incidence = no events, sum py, rate/py (95% CI)",
    "Adj = adjusted for variables indicated in baseline table.",
    "Adj IPW = adjusted for variables indicated in baseline table and using inverse probabilty weights for RASi and MRA respectively."
  )
)
```
